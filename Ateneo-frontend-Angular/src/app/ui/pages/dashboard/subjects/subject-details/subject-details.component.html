<div class="subject-details-container">
    <div class="students-table-container">
        <div class="table-wrapper">
            <mat-table [dataSource]="studentsList" class="students-table" *ngIf="studentsList.length > 0 && gradesList.length > 0">
                <ng-container matColumnDef="identification">
                    <mat-header-cell *matHeaderCellDef>DNI</mat-header-cell>
                    <mat-cell *matCellDef="let student" [title]="student.dni" class="ellipsis-cell">{{ student.dni }}</mat-cell>
                </ng-container>

                <ng-container matColumnDef="name">
                    <mat-header-cell *matHeaderCellDef>Estudiante</mat-header-cell>
                    <mat-cell *matCellDef="let student" [title]="student.firstName + ' ' + student.lastName">
                        <span class="name-content">{{ student.firstName }} {{ student.lastName }}</span>
                    </mat-cell>
                </ng-container>

                <ng-container *ngFor="let grade of gradesList; trackBy: trackByGradeId" [matColumnDef]="grade.id">
                    <mat-header-cell *matHeaderCellDef>
                        <div class="grade-header-container">
                            <span class="grade-header" [title]="grade.name">{{ grade.name }}</span>
                            <div class="grade-actions">
                                <button
                                    mat-icon-button
                                    (click)="openEditGradeModal(grade.id); $event.stopPropagation()"
                                    class="edit-grade-btn"
                                    title="Editar nota"
                                >
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button
                                    *ngIf="isGradeFinal(grade.id)"
                                    mat-icon-button
                                    (click)="openLoadStudentGradesModal(grade.id); $event.stopPropagation()"
                                    class="load-grades-btn"
                                    title="Cargar notas de alumnos"
                                >
                                    <mat-icon>assignment</mat-icon>
                                </button>
                            </div>
                        </div>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let student" [title]="getStudentGradeValue(student, grade.id)" class="ellipsis-cell">
                        {{ getStudentGradeValue(student, grade.id) }}
                    </mat-cell>
                </ng-container>

                <ng-container matColumnDef="attendance">
                    <mat-header-cell *matHeaderCellDef>Asistencias</mat-header-cell>
                    <mat-cell *matCellDef="let student" [title]="getStudentAttendance(student) + '%'" class="ellipsis-cell">
                        {{ getStudentAttendance(student) }}%
                    </mat-cell>
                </ng-container>

                <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
                <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
            </mat-table>
            <div class="no-data-fake-cell" *ngIf="studentsList.length === 0">No hay alumnos cargados en la materia</div>
            <div class="no-data-fake-cell" *ngIf="studentsList.length > 0 && gradesList.length === 0">
                No hay notas cargadas en la materia
            </div>
        </div>
    </div>
    <div class="calendar-container" *ngIf="!showClassPanel && !showReportPanel">
        <h3>Calendario de Clases</h3>
        <mat-calendar [(selected)]="selectedDate" [dateClass]="dateClass" (selectedChange)="onDateSelected($event)"> </mat-calendar>
    </div>
    <app-class-details-panel
        *ngIf="showClassPanel"
        class="class-panel-expanded"
        [classData]="selectedClassForPanel"
        [selectedDate]="selectedDate"
        [students]="studentsList"
        [subjectId]="idSubject"
        (onComplete)="onClassPanelComplete()"
        (onClassSaved)="onClassSaved($event)"
    >
    </app-class-details-panel>
    <app-academic-summary-panel
        *ngIf="showReportPanel"
        class="academic-summary-panel-expanded"
        [students]="studentsList"
        [subjectId]="idSubject"
        (onComplete)="onReportPanelComplete()"
    >
    </app-academic-summary-panel>
    <div class="buttons-container" *ngIf="!showClassPanel && !showReportPanel">
        <button class="primary-button full-width-btn" mat-flat-button (click)="openAddStudentModal()">Agregar alumno</button>
        <app-add-grade-button
            [grades]="viewModel.grades$ | async"
            [subjectId]="idSubject"
            [students]="studentsList"
            (gradeAdded)="onDataChanged()"
        ></app-add-grade-button>
        <button
            class="primary-button full-width-btn"
            mat-flat-button
            (click)="openReportPanel()"
            [disabled]="studentsList.length === 0 || gradesList.length === 0"
        >
            Generar informe
        </button>
        <button class="primary-button full-width-btn" mat-flat-button>Editar materia</button>
        <button class="primary-button full-width-btn" mat-flat-button>Eliminar materia</button>
    </div>
</div>

<ng-template #addStudentModal>
    <div class="modal-add-student">
        <p class="student-data-title">Ingreso del DNI del alumno</p>
        <div class="search-student-container">
            <mat-form-field appearance="outline" class="dni-input">
                <mat-label>Verificar si existe un alumno</mat-label>
                <input matInput placeholder="Ingrese el DNI" [(ngModel)]="dniInput" type="text" />
            </mat-form-field>
            <app-submit
                type="button"
                [disabled]="isSearchingStudent || !dniInput"
                [loading]="isSearchingStudent"
                [withText]="true"
                [class]="'primary'"
                (click)="searchStudentByDni()"
            >
                Buscar
            </app-submit>
        </div>

        <div class="search-result-container" *ngIf="searchedDni">
            <div class="centered-modal-content">
                <mat-chip color="primary" selected class="dni-chip">DNI buscado: {{ searchedDni }}</mat-chip>
                <div *ngIf="foundStudent" class="student-data">
                    <p class="student-data-title">Datos del estudiante</p>
                    <div>Nombre: {{ foundStudent.firstName }}</div>
                    <div>Apellido: {{ foundStudent.lastName }}</div>
                    <div>Email: {{ foundStudent.email ? foundStudent.email : 'No tiene' }}</div>
                    <div>Teléfono: {{ foundStudent.phone ? foundStudent.phone : 'No tiene' }}</div>
                    <div *ngIf="foundStudent && isStudentInSubject(foundStudent)" class="already-in-subject-chip">
                        El alumno ya está en la materia
                    </div>
                </div>
                <div *ngIf="!foundStudent" class="student-create-form">
                    <p class="create-student-title">Crear nuevo estudiante</p>
                    <div class="form-fields-container">
                        <mat-form-field appearance="outline" class="student-form-field">
                            <mat-label>Nombre</mat-label>
                            <input
                                matInput
                                placeholder="Nombre"
                                [(ngModel)]="newStudent.firstName"
                                (ngModelChange)="onNewStudentFormChange()"
                                [class.input-error]="isFirstNameInvalid"
                            />
                        </mat-form-field>
                        <div class="error-message" *ngIf="isFirstNameInvalid">El nombre es obligatorio</div>
                        <mat-form-field appearance="outline" class="student-form-field">
                            <mat-label>Apellido</mat-label>
                            <input
                                matInput
                                placeholder="Apellido"
                                [(ngModel)]="newStudent.lastName"
                                (ngModelChange)="onNewStudentFormChange()"
                                [class.input-error]="isLastNameInvalid"
                            />
                        </mat-form-field>
                        <div class="error-message" *ngIf="isLastNameInvalid">El apellido es obligatorio</div>
                        <mat-form-field appearance="outline" class="student-form-field">
                            <mat-label>Email</mat-label>
                            <input
                                matInput
                                placeholder="Email"
                                [(ngModel)]="newStudent.email"
                                (ngModelChange)="onNewStudentFormChange()"
                                [class.input-error]="isEmailInvalid"
                            />
                        </mat-form-field>
                        <div class="error-message" *ngIf="isEmailInvalid">El email debe tener el formato: ejemplo&#64;dominio.com</div>
                        <mat-form-field appearance="outline" class="student-form-field">
                            <mat-label>Teléfono</mat-label>
                            <input
                                matInput
                                placeholder="Teléfono"
                                [(ngModel)]="newStudent.phone"
                                (ngModelChange)="onNewStudentFormChange()"
                            />
                        </mat-form-field>
                    </div>
                    <div *ngIf="foundStudent && isStudentInSubject(foundStudent)" class="already-in-subject-message">
                        El alumno ya está en la materia
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #editGradeModal>
    <div class="modal-edit-grade">
        <p class="grade-data-title">Datos de la nota</p>
        <div class="form-fields-container">
            <mat-form-field appearance="outline" class="grade-form-field">
                <mat-label>Título de la nota</mat-label>
                <input
                    matInput
                    placeholder="Título de la nota"
                    [(ngModel)]="editGradeData.name"
                    (ngModelChange)="onEditGradeFormChange()"
                    required
                />
                <mat-error>El nombre es obligatorio</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" class="grade-form-field">
                <mat-label>Tipo de nota</mat-label>
                <mat-select [(ngModel)]="editGradeData.type" disabled required>
                    <mat-option value="Final">Final</mat-option>
                    <mat-option value="Weighted">Ponderada</mat-option>
                    <mat-option value="Average">Promedio</mat-option>
                </mat-select>
                <mat-error>El tipo es obligatorio</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" class="grade-form-field">
                <mat-label>Fecha</mat-label>
                <input
                    matInput
                    [matDatepicker]="editPicker"
                    placeholder="Fecha"
                    [(ngModel)]="editGradeData.date"
                    (ngModelChange)="onEditGradeFormChange()"
                    required
                />
                <mat-datepicker-toggle matSuffix [for]="editPicker"></mat-datepicker-toggle>
                <mat-datepicker #editPicker></mat-datepicker>
                <mat-error>La fecha es obligatoria</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" class="grade-form-field">
                <mat-label>Descripción (opcional)</mat-label>
                <textarea matInput placeholder="Descripción" [(ngModel)]="editGradeData.description"></textarea>
            </mat-form-field>

            <!-- Sección de notas base para Weighted y Average -->
            <div *ngIf="editGradeData.type === 'Weighted' || editGradeData.type === 'Average'" class="base-grades-section">
                <div class="info-message">
                    <strong>Notas relacionadas:</strong> Seleccione al menos 2 notas base.
                    <span *ngIf="editGradeData.type === 'Weighted'"> Asigne porcentajes de peso que sumen 100.</span>
                </div>

                <mat-form-field appearance="outline" class="grade-select-field">
                    <mat-label>Seleccionar nota</mat-label>
                    <mat-select [(ngModel)]="selectedEditBaseGradeId" (selectionChange)="onEditBaseGradeSelect($event.value)">
                        <mat-option *ngFor="let grade of availableGradesForEdit" [value]="grade.id">
                            {{ grade.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <div *ngIf="editBaseGrades.length > 0" class="base-grades-list">
                    <div *ngFor="let baseGrade of editBaseGrades; let i = index" class="base-grade-item">
                        <div class="base-grade-row">
                            <button mat-icon-button color="warn" (click)="removeEditBaseGrade(i)" class="remove-btn">
                                <mat-icon>close</mat-icon>
                            </button>
                            <span class="grade-name-label">{{ baseGrade.gradeName }}</span>
                        </div>
                        <ng-container *ngIf="editGradeData.type === 'Weighted'">
                            <mat-form-field appearance="outline" class="weight-field">
                                <mat-label>Peso</mat-label>
                                <input
                                    matInput
                                    type="number"
                                    min="1"
                                    max="99"
                                    [(ngModel)]="baseGrade.weight"
                                    (ngModelChange)="onEditWeightChange()"
                                />
                                <mat-error>El peso debe estar entre 1 y 99</mat-error>
                            </mat-form-field>
                        </ng-container>
                    </div>
                    <div *ngIf="editGradeData.type === 'Weighted'" class="weight-total" [class.weight-error]="getEditTotalWeight() !== 100">
                        Total: {{ getEditTotalWeight() }}%
                        <span *ngIf="getEditTotalWeight() !== 100" class="error-text"> (debe ser 100)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #loadStudentGradesModal>
    <div class="modal-load-grades">
        <p class="load-grades-title">Cargar notas de los alumnos</p>
        <div class="students-grades-list">
            <div *ngFor="let studentGrade of loadStudentGradesData" class="student-grade-row vertical">
                <span class="student-name">{{ studentGrade.studentName }}</span>
                <mat-form-field appearance="outline" class="grade-input-field">
                    <mat-label>Nota</mat-label>
                    <input
                        matInput
                        type="number"
                        min="1"
                        max="10"
                        step="1"
                        [(ngModel)]="studentGrade.value"
                        (ngModelChange)="onLoadStudentGradeChange()"
                        placeholder="1-10"
                    />
                    <mat-error *ngIf="studentGrade.value !== null && (studentGrade.value < 1 || studentGrade.value > 10)">
                        La nota debe estar entre 1 y 10
                    </mat-error>
                </mat-form-field>
            </div>
        </div>
    </div>
</ng-template>
